name: Backend Blue/Green Switch

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose Action"
        required: true
        type: choice
        options:
          - promote-idle
          - rollback-active

jobs:
  switch:
    runs-on: ubuntu-latest

    steps:
      - name: Read current ACTIVE & IDLE Envs
        run: |
          echo "ACTIVE=${{ secrets.ACTIVE_ENV }}"
          echo "IDLE=${{ secrets.IDLE_ENV }}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Switch Traffic
        run: |
          ACTIVE=${{ secrets.ACTIVE_ENV }}
          IDLE=${{ secrets.IDLE_ENV }}

          HTTPS_LISTENER="${{ secrets.ALB_LISTENER_ARN }}"
          HTTP_LISTENER="${{ secrets.ALB_LISTENER_HTTP_ARN }}"

          if [ "${{ github.event.inputs.action }}" = "promote-idle" ]; then
            echo "Promoting IDLE (${IDLE}) to ACTIVE"

            # IDLE 타겟 그룹 ARN 선택
            if [ "$IDLE" = "blue" ]; then
              TG="${{ secrets.TG_BLUE_ARN }}"
            else
              TG="${{ secrets.TG_GREEN_ARN }}"
            fi

            # ALB에 적용
            aws elbv2 modify-listener --listener-arn $HTTPS_LISTENER \
              --default-actions Type=forward,TargetGroupArn=$TG

            aws elbv2 modify-listener --listener-arn $HTTP_LISTENER \
              --default-actions Type=forward,TargetGroupArn=$TG

            echo "Traffic switched to $IDLE"

            echo "::warning:: Update Secrets: ACTIVE_ENV=$IDLE, IDLE_ENV=$ACTIVE"

          else
            echo "Rollback requested: Switching back to $ACTIVE"

            if [ "$ACTIVE" = "blue" ]; then
              TG="${{ secrets.TG_BLUE_ARN }}"
            else
              TG="${{ secrets.TG_GREEN_ARN }}"
            fi

            aws elbv2 modify-listener --listener-arn $HTTPS_LISTENER \
              --default-actions Type=forward,TargetGroupArn=$TG

            aws elbv2 modify-listener --listener-arn $HTTP_LISTENER \
              --default-actions Type=forward,TargetGroupArn=$TG

            echo "Traffic rolled back to $ACTIVE"

          fi
